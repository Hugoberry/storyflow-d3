<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head lang="en">
	<meta charset="UTF-8">
	<title>StoryFlow: Tracking the Evolution of Stories</title>
	<link rel="stylesheet" type="text/css" href="lib/jquery-ui-themes-1.11.4/themes/flick/jquery-ui.min.css"/>
	<script type="text/javascript" src="lib/d3.v3.js"></script>
	<script type="text/javascript" src="lib/jquery-ui-1.11.4/external/jquery/jquery.js"></script>
	<script type="text/javascript" src="lib/jquery-ui-1.11.4/jquery-ui.min.js"></script>
	<script type="text/javascript" src="lib/randomColor.js"></script>
</head>
<body>
<script type="text/javascript">
	// http://stackoverflow.com/questions/9838812/how-can-i-open-a-json-file-in-javascript-without-jquery
	function loadJSON(path, success, error) {
		var xhr = new XMLHttpRequest();

		xhr.onreadystatechange = function () {
			if (xhr.readyState === XMLHttpRequest.DONE) {
				if (xhr.status === 200) {
					if (success)
						success(JSON.parse(xhr.responseText));
				} else {
					if (error)
						error(xhr);
				}
			}
		};

		xhr.open("GET", path, true);
		xhr.send();
	}

	var annotateDataset = function (dataset, options) {
		// Keep track of the end time of the last session in each level
		var levels = [];

		// Store the sessions which will be removed
		var sessionsToRemove = [];

		// Compute the level of each sessions and identify the ones that will be removed
		dataset.sessions.forEach(function(session) {
			if(options.sessions.removeNoInteraction == true && session.members.length == 1) {
				sessionsToRemove.push(session);
			} else {
				for (i = 0; i < levels.length && session.d3 == undefined; ++i) {
					if (levels[i] < session.start) {
						session.d3 = {"level": i};
						levels[i] = session.end;
					}
				}

				if (session.d3 == undefined) {
					levels[levels.length] = session.end;
					session.d3 = {"level": levels.length - 1};
				}
			}
		});

		// Remove sessions
		sessionsToRemove.forEach(function(session) {
			dataset.sessions.splice(dataset.sessions.indexOf(session), 1);
		});

		// Generate the colors of the characters
		var colors = randomColor({count: dataset.characters.length});

		// Remove the previous SVG container
		d3.select(options.svg.element).select("svg").remove();

		// Create the SVG container
		var svg = d3.select(options.svg.element).append("svg").attr("height", options.svg.height).attr("width", options.svg.width);

		var sampleTextDataset = [ { value: "Sample text" } ];

		svg.selectAll("text").data(sampleTextDataset).enter().append("text")
				.text(function(d) { return d.value; })
				.each(function(d) { d.rect = this.getBBox(); });

		svg.selectAll("text").remove();

		// Create the characters scale
		var characterScale = d3.scale.linear()
				.domain([0, dataset.characters.length - 1])
				.range([sampleTextDataset[0].rect.height, options.svg.height]);

		// Assign each character a color and its coordinates
		for(i = 0; i < dataset.characters.length; ++i) {
			dataset.characters[i].d3 = {
				x: 0,
				y: characterScale(i),
				color: colors[i]
			};
		}

		// Add the characters to the canvas and get their computed rectangles
		svg.selectAll("text").data(dataset.characters).enter().append("text")
				.attr("x", function(d) { return d.d3.x; })
				.attr("y", function(d) { return d.d3.y; })
				.text(function(d) { return d.name; })
				.each(function(d) { d.d3.box = this.getBBox(); });

		// Compute the maximum width of the characters's rectangles
		var maxCharactersWidth = dataset.characters.map(function(x) { return x.d3.box.width; })
				.reduce(function(x, y) { return Math.max(x, y); });

		// Compute the first point on the path of each character's line
		dataset.characters.forEach(function(character) {
			character.d3.points = [{
				x: character.d3.box.width + options.characters.nameOffset,
				y: character.d3.box.y + character.d3.box.height / 2
			}];
		});

		// Compute the number of levels
		var maxLevels = dataset.sessions.map(function(x) { return x.d3.level; })
				.reduce(function(x, y) { return Math.max(x, y); });

		console.log("Number of levels: ", maxLevels + 1);

		// Compute the maximum number of interactions a session contains
		var maxMembers = dataset.sessions.map(function(x) { return x.members.length; })
				.reduce(function(x, y) { return Math.max(x, y); });

		console.log("Maximum members / session: ", maxMembers);

		// Compute the story timeframe
		var timeframe = dataset.sessions.map(function(x) { return {start: x.start, end: x.end}; })
				.reduce(function(x, y) { return {start: Math.min(x.start, y.start), end: Math.max(x.end, y.end)}; });

		console.log("Timeframe: ", timeframe);

		// Create various scales used to process the dataset
		var sessionVerticalScale = d3.scale.linear()
				.domain([0, maxLevels])
				.range([0, options.svg.height]);

		var sessionHeightScale = d3.scale.linear()
				.domain([0, maxMembers])
				.range([0, options.svg.height / maxMembers]);

		var sessionWidthScale = d3.scale.linear()
				.domain([timeframe.start, timeframe.end])
				.range([0, options.svg.width - maxCharactersWidth]);

		var sessionHorizontalScale = d3.scale.linear()
				.domain([timeframe.start, timeframe.end])
				.range([maxCharactersWidth, options.svg.width]);

		// Compute the coordinates of the session boxes and add connect them to the characters
		dataset.sessions.forEach(function(session) {
			var padding = (options.sessions.compress / 2) * (session.end - session.start + 1)

			session.d3.x = session.start + padding;
			session.d3.x = sessionHorizontalScale(session.d3.x);

			session.d3.width = (session.end - session.start + 1) - 2 * padding;
			session.d3.width = sessionWidthScale(session.d3.width);

			session.d3.y = sessionVerticalScale(session.d3.level);
			session.d3.height = sessionHeightScale(session.members.length);

			var lineVerticalScale = d3.scale.linear()
					.domain([0, session.members.length - 1])
					.range([session.d3.y, session.d3.y + session.d3.height]);

			for(i = 0; i < session.members.length; ++i) {
				member = dataset.characters.filter(function(x) { return x.id == session.members[i] })[0];

				member.d3.points.push(
						{ x: session.d3.x, y: lineVerticalScale(i) },
						{ x: session.d3.x + session.d3.width, y: lineVerticalScale(i) }
				);
			}
		});

		// Add the session boxes to the canvas
		svg.selectAll("rect").data(dataset.sessions).enter().append("rect")
				.attr("x", function(d) { return d.d3.x; })
				.attr("y", function(d) { return d.d3.y; })
				.attr("height", function(d) { return d.d3.height; })
				.attr("width", function(d) { return d.d3.width; });

		// Draw the story lines
		dataset.characters.forEach(function (character) {
			var line_function = d3.svg.line().interpolate(options.characters.interpolation)
					.x(function (d) { return d.x; })
					.y(function (d) { return d.y; });

			var story_lines = svg.append("path")
					.attr("d", line_function(character.d3.points))
					.attr("fill", "none")
					.attr("stroke", character.d3.color)
					.attr("stroke-width", 2);
		});

		return dataset;
	};

	var visualizeDataset = function(path) {
		loadJSON(path, function(dataset) {
			annotateDataset(dataset, options);
		}, null);
	};

	var options = {
		svg: {
			element: "#canvas",
			height: 950,
			width: 1260
		},
		characters: {
			interpolation: "step",
			nameOffset: 10
		},
		sessions: {
			removeNoInteraction: true,
			compress: 0
		}
	};

	$(document).ready(function() {
		$("#dataset").selectmenu({
			width: 230,
			select: function (event, ui) {
				visualizeDataset($("#dataset").val(), options);
			}
		}).trigger("select");

		$("#interpolation").selectmenu({
			width: 200,
			select: function (event, ui) {
				options.characters.interpolation = ui.item.value;

				visualizeDataset($("#dataset").val(), options);
			}
		});

		visualizeDataset($("#dataset").val(), options);

		$("#compress").slider({
			min: 0,
			max: 1,
			step: 0.1,
			value: options.sessions.compress,
			width: 100,
			slide: function(event, ui) {
				options.sessions.compress = ui.value;

				visualizeDataset($("#dataset").val(), options);
			}
		});
	});
</script>

<table>
	<tr>
		<td>
			<select name="dataset" id="dataset">
				<option value="dataset/the_matrix.json" selected>The Matrix</option>
				<option value="dataset/alice_in_wonderland.json">Alice in Wonderland</option>
				<option value="dataset/star_wars.json">Star Wars</option>
			</select>
		</td>
		<td>
			<select name="interpolation" id="interpolation">
				<option value="linear">Linear</option>
				<option value="linear-closed">Linear-closed</option>
				<option value="step" selected>Step</option>
				<option value="step-before">Step-before</option>
				<option value="step-after">Step-after</option>
				<option value="basis">Basis</option>
				<option value="basis-open">Basis-open</option>
				<option value="basis-closed">Basis-closed</option>
				<option value="bundle">Bundle</option>
				<option value="cardinal">Cardinal</option>
				<option value="cardinal-open">Cardinal-open</option>
				<option value="cardinal-closed">Cardinal-closed</option>
				<option value="monotone">Monotone</option>
			</select>
		</td>
		<td>
			<div id="compress" style="display: inline-block; vertical-align: super; margin-left: 10px; width: 200px"/>
		</td>
	</tr>
</table>

<div id="canvas"/>
</body>
</html>