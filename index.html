<!DOCTYPE html>
<html>
<head lang="en">
	<meta charset="UTF-8">
	<title>StoryFlow: Tracking the Evolution of Stories</title>
	<script type="text/javascript" src="d3/d3.v3.js"></script>
</head>
<body>
	<script type="text/javascript">
		// http://stackoverflow.com/questions/9838812/how-can-i-open-a-json-file-in-javascript-without-jquery
		function load_json(path, success, error)
		{
			var xhr = new XMLHttpRequest();

			xhr.onreadystatechange = function()
			{
				if (xhr.readyState === XMLHttpRequest.DONE) {
					if (xhr.status === 200) {
						if (success)
							success(JSON.parse(xhr.responseText));
					} else {
						if (error)
							error(xhr);
					}
				}
			};

			xhr.open("GET", path, true);
			xhr.send();
		}

		load_json("dataset/alice_in_wonderland.json", function(dataset) {
			var annotateDataset = function (dataset) {
				return dataset;
			};

			var plotDataset = function(dataset) {
				// Define drawing parameters
				var svg_width = window.innerWidth - 30;
				var svg_height = window.innerHeight;

				var character_x = 0;
				var character_spacing_y = 40;

				var session_offset_x = 120;
				var session_offset_y = -10;
				var session_scale_x = 20;
				var session_scale_y = 38;
				var session_height = 20;
				var session_single_width = 5;

				// Compute the coordinates of the characters
				for(i = 0; i < dataset.characters.length; ++i) {
					character_name = dataset.characters[i];

					dataset.characters[i] = {};
					dataset.characters[i].name = character_name;
					dataset.characters[i].d3 = {};
					dataset.characters[i].d3.x = character_x;
					dataset.characters[i].d3.y = character_spacing_y * (i + 1);
				}

				// Compute the coordinates of the session boxes
				dataset.sessions.forEach(function(session) {
					session.d3 = {};
					session.d3.x = session_offset_x + session_scale_x * session.start;
					session.d3.y = session_offset_y + session_scale_y * session.level;

					if(session.end - session.start == 0)
						session.d3.width = session_single_width;
					else
						session.d3.width = session_scale_x * (session.end - session.start);
				});

				// Create the SVG container
				var svg_container = d3.select("body").append("svg").attr("width", svg_width).attr("height", svg_height);

				// Display the characters
				var characters = svg_container.selectAll("text").data(dataset.characters).enter().append("text")
						.attr("x", function(d) { return d.d3.x; })
						.attr("y", function(d) { return d.d3.y; })
						.text(function(d) { return d.name; });

				// Draw the session boxes
				var rectangle = svg_container.selectAll("rect").data(dataset.sessions).enter().append("rect")
						.attr("x", function(d) { return d.d3.x })
						.attr("y", function(d) { return d.d3.y; })
						.attr("height", session_height)
						.attr("width", function(d) { return d.d3.width; })
						.attr("fill", "black");
			};

			plotDataset(annotateDataset(dataset));
		}, null);
	</script>
</body>
</html>